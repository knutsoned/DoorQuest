<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1,maximum-scale=1.0, minimum-scale=1.0"
    />
    <title>Door Quest</title>
    <meta name="description" content="An endless opener" />
    <meta name="author" content="Ed Knutson" />
  </head>

  <body>
    <div id="main-top-wrapper">
      <canvas id="renderCanvas" touch-action="none"></canvas>
      <script type="module" src="/src/index.ts"></script>
      <nav id="sidebar">
        <h1>Door Quest</h1>
        <div id="audio">
          <button id="musicBtn" onclick="toggleMusicOn()">Music On (M)</button>
          <!--<button id="soundBtn" onclick="toggleSoundOn()">SFX On (S)</button>-->
          <br>
          <p>Click the game canvas if controls don't work</p>
          <br>
          <!--<h2>Controls</h2>-->
          <div class="row">
            <div class="column">
              <!--
              <p>Left Flipper: A</p>
              <p>Right Flipper: D</p>
              -->
            </div>
            <div class="right column">
              <button id="bKey" class="key" onclick="press('b')">Boss Key: B</button>
              <button id="rKey" class="key" onclick="press('r')">Reset: R</button>
            </div>
          </div>
          <div class="row">
            <div class="column">
              <!--
              <button id="aKey" class="key" onclick="press('a')">A</button>
              <button id="dKey" class="key" onclick="press('d')">D</button>
              -->
            </div>
            <div class="right column">
              <br />
              <br />
              <h3 id="logo">SoffiTech</h3>
          </div>
        </div>
      </nav>
      <div id="boss" class="full" onclick="hideBoss()">
        <div id="windoze"></div>
      </div>
      <div id="loading" class="full">
        <h1>Loading <span id="ellipsis"></span></h1>
      </div>
    </div>
    <audio id="sound"></audio>
    <script>
      const boss = document.getElementById("boss");
      const ellipsis = document.getElementById("ellipsis");
      const musicBtn = document.getElementById("musicBtn");
      const soundBtn = document.getElementById("soundBtn");
      window.boss = false;
      window.gameOver = false;
      window.loading = true;
      window.musicOn = false;
      window.soundOn = false;
      window.pressedA = false;
      window.pressedD = false;

      function hideBoss() {
        window.boss = false;
        boss.style.display = "none";
      }

      function showBoss() {
        window.boss = true;
        boss.style.display = "block";
      }

      function press(key) {
        switch (key) {
          case "a":
            window.pressedA = true;
            break;
          case "d":
            window.pressedD = true;
            break;
            case "b": // boss key
            showBoss();
            break;
          case "r": // reset
            window.gameOver = true;
            break;
        }
      }

      document.onkeypress = function (e) {
        e = e || window.event;
        if (window.boss) {
          hideBoss();
          e.preventDefault();
          return;
        }
        switch (e.key) {
          case 'b':
            e.preventDefault();
          case 'r':
            press(e.key);
          break
        }
      };

      window.au = new AudioContext()

      function toggleMusicOn() {
        console.log("toggle music");
        if (!window.musicOn) {
          window.au.resume()
        }
        window.musicOn = !window.musicOn;
        musicBtn.innerText =
          "Music " + (window.musicOn ? "Mute" : "On") + " (M)";
      }

      function toggleSoundOn() {
        console.log("toggle sound");
        if (!window.soundOn) {
          window.au.resume()
        }
        window.soundOn = !window.soundOn;
        soundBtn.innerText = "SFX " + (window.soundOn ? "Mute" : "On") + " (S)";
      }

      let ellipsisLength = 0;
      function loadingEllipsis() {
        console.log("loading");
        if (loading) {
          let periods = "";
          if (++ellipsisLength > 3) {
            ellipsisLength = 0;
          }
          for (let i = 0; i < ellipsisLength; i++) {
            periods += ". ";
          }
          ellipsis.innerText = periods;
          setTimeout(loadingEllipsis, 140);
        }
      }
      loadingEllipsis();

      function hideLoading() {
        console.log("loaded");
        window.loading = false;
        document.getElementById("loading").style.display = "none";
      }
    </script>
  </body>
</html>
